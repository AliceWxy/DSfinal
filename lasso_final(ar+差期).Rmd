```{r}
load(url("https://github.com/zhentaoshi/Econ5821/raw/main/data_example/dataset_inf.Rdata"))
X_colnames <- read.csv("https://github.com/zhentaoshi/Econ5821/raw/main/data_example/X_colnames.csv")
colnames(X) = paste0("x", X_colnames$X)
```

```{r}
#将数据差一期整合在一起
cpi <- cpi[-168,-1]
X <- X[-1,]
data <- cbind(X,cpi)
data <- data[,-1]
```
#使用mutate()和across()函数将X中的所有变量转换为数值型+列出CPI
```{r}
library(dplyr)
data <- data  %>% mutate(across(everything(), as.numeric))
data [is.na(data )] <- 0
data [, sapply(data , is.factor)] <- lapply(data [, sapply(data , is.factor)], as.numeric)
#合并
data$CPI <- cpi$CPI
```

加入airma
```{r}
install.packages("forecast")
library(forecast)
library(caTools)
set.seed(123) # 为了复现结果，设置随机数种子
split <- sample.split(data$x1, SplitRatio = 0.7)#x1是时间向量
train <- subset(data, split == TRUE)
test <- subset(data, split == FALSE)
```

```{r}
# 拟合 ARIMA 模型并预测训练集 时间变量：x1
fit <- Arima(train$x1, order=c(1,1,1))
train$y_pred <- predict(fit)$pred

# 将 ARIMA 模型的预测结果作为外生变量
train$y_arima <- residuals(fit)

# 将训练集中的特征变量和外生变量分别存储在矩阵和向量中
x <- as.matrix(train[, c("CPI", "y_arima")])
y <- as.vector(train$CPI)

# 拟合模型，alpha = 1 表示使用 Lasso 正则化
cvfit <- cv.glmnet(x, y, alpha = 1) 
# 预测测试集的目标变量
library(glmnet)
test$y_arima <- predict(fit, n.ahead = nrow(test))$pred
x.test <- as.matrix(test[, c("CPI", "y_arima")])
y.test <- as.vector(test$CPI)
y.pred <- predict(cvfit, newx = x.test)

# 计算均方误差
mse <- mean((y.test - y.pred)^2)
# 计算R^2
r2 <- 1 - sum((y.test - y.pred)^2) / sum((y.test - mean(y.test))^2)
```
